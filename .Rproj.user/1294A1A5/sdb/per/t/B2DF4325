{
    "collab_server" : "",
    "contents" : "server <- function(input, output) { \n  loadfile <- observeEvent(input$loadfile,{\n    file1 <- input$files\n    if(is.null(file1)) return(NULL)\n    load(file1$datapath)\n  })\n  # tab11----\n  # 词云\n  output$wc <- renderWordcloud2({\n    wc_all$terms_counts = wc_all$term_count*100\n    wordcloud2(wc_all[1:70, ], fontWeight = 100)\n  })\n  # 上升最多\n  output$increase = renderPlotly({\n    all_rank1 = arrange(all_rank, desc(trueDiff))[1:20, ]\n    temp = ggplot(all_rank1, aes(x=reorder(terms, desc(trueDiff)), y=trueDiff)) + geom_bar(stat = 'identity') + theme(axis.text.x = element_text(face = \"bold\",angle = 90)) + ggtitle('上升最多的词')\n    ggplotly(temp, width = 1000, height = 400)\n  })\n  # 下降最多\n  output$decrease = renderPlotly({\n    all_rank1 = arrange(all_rank, trueDiff)[1:20, ]\n    temp = ggplot(all_rank1, aes(x=reorder(terms, desc(abs(trueDiff))), y=abs(trueDiff))) + geom_bar(stat = 'identity') + theme(axis.text.x = element_text(face = \"bold\",angle = 90)) + ggtitle('下降最多的词')\n    ggplotly(temp, width = 1000, height = 400)\n  })\n  # _三项指标的趋势图\n  output$three_trend = renderPlotly({\n    all_inf1 = select(all_inf, yearmonth, Taste:Service) %>% melt(., id = 'yearmonth')\n    a = ggplot(all_inf1 , aes(x=yearmonth, y=value, group=variable, colour=variable)) +\n      geom_line() + theme(axis.text.x = element_text(angle = 45)) + ggtitle('三项指标趋势图')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  # _情绪分数的趋势图\n  output$senti_trend = renderPlotly({\n    a = ggplot(all_inf , aes(x=yearmonth, y=senti, group=1, colour=1)) +\n      geom_line() + theme(axis.text.x = element_text(angle = 45)) + ggtitle('负面评语趋势图')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  # 提到次数最多的前20项产品\n  output$top20_product = renderPlotly({\n    a = ggplot(product_inf %>% arrange(., desc(count)) %>% .[2:21, ],\n               aes(x = reorder(product, desc(count)), y = count)) + \n      geom_bar(stat='identity') + theme(axis.text.x = element_text(angle = 90)) + ggtitle('提到次数最多的前20项产品')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  # 味道分数最低的20项产品\n  output$lowTaste_product = renderPlotly({\n    a = ggplot(product_inf %>% arrange(., taste) %>% .[1:20, ],\n               aes(x = reorder(product, taste), y = taste, fill = count)) + \n      geom_bar(stat='identity') + theme(axis.text.x = element_text(angle = 90)) + ggtitle('味道分数最低的20项产品')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  # 负面情绪最多的前20项产品\n  output$lowSenti_product = renderPlotly({\n    a = ggplot(product_inf %>% arrange(., desc(senti)) %>% .[1:20, ],\n               aes(x = reorder(product, desc(senti)), y = senti)) + \n      geom_bar(stat='identity') + theme(axis.text.x = element_text(angle = 90)) + ggtitle('负面评语最多的前20项产品')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  # 提到次数最多的20间门店\n  output$top20_shop = renderPlotly({\n    a = ggplot(shop_inf %>% arrange(., desc(count)) %>% .[1:20, ],\n               aes(x = reorder(shop, desc(count)), y = count)) + \n      geom_bar(stat='identity') + theme(axis.text.x = element_text(angle = 90)) + ggtitle('提到次数最多的20间门店')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  # 服务分数最低的20间门店\n  output$lowService_shop = renderPlotly({\n    temp = shop_inf %>% arrange(., service) %>% .[1:20, ]\n    a = ggplot(temp, aes(x = reorder(shop, service), y = service)) + geom_bar(stat = 'identity') +\n      theme(axis.text.x = element_text(angle = 90)) + ggtitle('服务分数最低的20间门店')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  # 负面情绪最多的20间门店\n  output$lowSenti_shop = renderPlotly({\n    a = ggplot(shop_inf %>% arrange(., desc(senti)) %>% .[1:20, ],\n               aes(x = reorder(shop, desc(senti)), y = senti)) + \n      geom_bar(stat='identity') + theme(axis.text.x = element_text(angle = 90)) + ggtitle('负面评语最多的20间门店')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  #----\n  \n  # tab12----\n  output$shopn <- renderUI({\n    selectInput(\"varables\",\"門店\",levels(as.factor(kdyjscy_comment$name)),\n                multiple=TRUE, selectize=TRUE)\n  })\n  Crawl1 <- eventReactive(input$textout, {\n    target = input$varables\n    if (length(target) > 1) {\n      return(NULL)\n    }\n    trend_shop = kdyjscy_comment %>% filter(., name == target)\n    # 趋势\n    trend_shop %<>% group_by(., yearmonth) %>% summarise(., count = n(),\n                                                         taste = mean(Taste),\n                                                         envir = mean(Envir),\n                                                         service = mean(Service),\n                                                         senti = sum(score<0) / (count+50) * 100)\n    return(trend_shop)\n  })\n  # 三项指标-门店\n  output$three_trend_shop = renderPlotly({\n    trend_shop2 = melt(Crawl1()[,c(1,3,4,5)], id = 'yearmonth')\n    a = ggplot(trend_shop2 , aes(x=yearmonth, y=value, group=variable, color = variable)) +\n      geom_line() + theme(axis.text.x = element_text(angle = 45)) + ggtitle('三项指标趋势图')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  # 负面情绪-门店\n  output$senti_shop = renderPlotly({\n    a = ggplot(Crawl1() , aes(x=yearmonth, y=senti, group=1)) +\n      geom_line() + theme(axis.text.x = element_text(angle = 45)) + ggtitle('负面评语趋势图')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  #----\n  \n  # tab13----\n  output$productn <- renderUI({\n    selectInput(\"varables2\",\"产品\",levels(as.factor(product)),\n                multiple=TRUE, selectize=TRUE)\n  })\n  Crawl2 <- eventReactive(input$textout2, {\n    target = input$varables2\n    if (length(target)>1) {\n      return(NULL)\n    }\n    trend_product = kdyjscy_comment %>% .[str_detect(.$Comment, target), ]\n    trend_product %<>% group_by(., yearmonth) %>% summarise(., count = n(),\n                                                            taste = mean(Taste),\n                                                            envir = mean(Envir),\n                                                            service = mean(Service),\n                                                            senti = sum(score<0) / (count+50) * 100)\n    return(trend_product)\n  })\n  # 三项指标-产品\n  output$three_trend_product = renderPlotly({\n    trend_product2 = melt(Crawl2()[,c(1,3,4,5)], id = 'yearmonth')\n    a = ggplot(trend_product2 , aes(x=yearmonth, y=value, group=variable, color = variable)) +\n      geom_line() + theme(axis.text.x = element_text(angle = 45)) + ggtitle('三项指标趋势图')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  # 负面情绪-产品\n  output$senti_product = renderPlotly({\n    a = ggplot(Crawl2() , aes(x=yearmonth, y=senti, group=1)) +\n      geom_line() + theme(axis.text.x = element_text(angle = 45)) + ggtitle('负面评语趋势图')\n    ggplotly(a, width = 1000, height = 400)\n  })\n  \n  #----\n  \n  # tab14----\n  output$lookdata <- DT::renderDataTable(\n    DT::datatable(\n      kdyjscy_comment[str_detect(kdyjscy_comment$Comment, input$search), c(15, 13, 5, 7:10)]\n    )\n  )\n  #----\n}# server",
    "created" : 1504153807840.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3029620958",
    "id" : "B2DF4325",
    "lastKnownWriteTime" : 1504160403,
    "last_content_update" : 1504160403197,
    "path" : "C:/work/liutongbu/kdyjscy/shiny/server.r",
    "project_path" : "shiny/server.r",
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}